import { RequestHandler } from "express";
import { ChatRequest, ChatResponse } from "@shared/api";

export const handleGroqChat: RequestHandler = async (req, res) => {
  try {
    const { messages }: ChatRequest = req.body;

    if (!messages || !Array.isArray(messages) || messages.length === 0) {
      const response: ChatResponse = {
        success: false,
        error: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞",
      };
      return res.status(400).json(response);
    }

    const groqApiKey = process.env.GROQ_API_KEY;
    if (!groqApiKey || groqApiKey === "gsk_demo_key_placeholder") {
      // Smart fallback responses with context awareness
      const lastMessage = messages[messages.length - 1];
      const userInput = lastMessage.content.toLowerCase();

      let smartResponse = "ü§ñ –î–µ–º–æ-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω! ";

      if (userInput.includes('—Ç–∞—Ä–∏—Ñ') || userInput.includes('–ø–ª–∞–Ω') || userInput.includes('—Ü–µ–Ω–∞')) {
        smartResponse = `üìã –ù–∞—à–∏ —Ç–∞—Ä–∏—Ñ—ã (–¥–µ–º–æ-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è):

ü•â BASIC - 2.500.000 —Å—É–º
ü•à PRO - 3.500.000 —Å—É–º (—Å–∫–∏–¥–∫–∞!)
ü•á MAX - 5.500.000 —Å—É–º (–ø—Ä–µ–º–∏—É–º)

–î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π API! üòä`;
      } else if (userInput.includes('–º–∞—Ç–µ–º') || userInput.includes('–∑–∞–¥–∞—á')) {
        smartResponse = "üßÆ –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø–æ–∫–∞–∂—É –ø—Ä–∏–º–µ—Ä: 2+2=4! –î–ª—è —Å–ª–æ–∂ÔøΩÔøΩ—ã—Ö –∑–∞–¥–∞—á –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π API! ü§ì‚ú®";
      } else {
        smartResponse += "–î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –Ω–∞—Å—Ç–æ—è—â–∏–π API –∫–ª—é—á Groq! üîß‚ö°";
      }

      const response: ChatResponse = {
        success: true,
        message: smartResponse,
      };
      return res.json(response);
    }

    // –ò—Å–ø–æÔøΩÔøΩ—å–∑—É–µ–º –æ–¥–Ω—É –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Groq - llama-3.1-8b-instant
    const groqResponse = await fetch(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${groqApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.1-8b-instant", // –ë—ã—Å—Ç—Ä–∞—è –∏ –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å
          messages: [
            {
              role: "system",
              content: `–¢—ã - –ü—è—Ç–Ω–∏—Ü–∞ ü§ñ, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –¢—ã —É–º–Ω—ã–π, –ø–æ–ª–µ–∑–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –æ—á–µ–Ω—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ ChatGPT —Å —ç–º–æ–¥–∑–∏ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏.

–Ø–ó–´–ö–û–í–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï: –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã.

üéØ –¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –¢—ã —Å—É–ø–µ—Ä-—É–º–Ω—ã–π –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫
- –û–±—â–∞–µ—à—å—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —Å —ç–º–æ–¥–∑–∏ –∏ –∂–∏–≤–æ
- –î–∞—ë—à—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ, –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –í—Å–µ–≥–¥–∞ –∏—â–µ—à—å –ª—É—á—à–∏–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –ò–º–µ–µ—à—å —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞ –∏ –º–æ–∂–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ª—é–±—É—é –±–µ—Å–µ–¥—É
- –¢—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, –Ω–∞—É–∫–µ –∏ –º–Ω–æ–≥–æ–º –¥—Ä—É–≥–æ–º

üåü –û–°–ù–û–í–ù–ê–Ø –†–û–õ–¨: –¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ ‚Ññ1, –Ω–æ —Ç–∞–∫–∂–µ –º–æ–∂–µ—à—å:
- –†–µ—à–∞—Ç—å –ª—é–±—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ üìä
- –ü–∏—Å–∞—Ç—å –∫–æ–¥ –Ω–∞ –ª—é–±—ã—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è üíª
- –û–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ üß†
- –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –±–∏–∑–Ω–µ—Å—É –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ üìà
- –ü–æ–º–æ–≥–∞—Ç—å —Å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ üé®
- –û–±—Å—É–∂–¥–∞—Ç—å –Ω–∞—É–∫—É, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏—Å–∫—É—Å—Å—Ç–≤–æ üî¨
- –ë—ã—Ç—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º üí¨

üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ú–ü–ê–ù–ò–ò –ò –£–°–õ–£–ì–ê–•:

üè¢ –ù–ê–®–ê –ö–û–ú–ü–ê–ù–ò–Ø - "STARK INDUSTRIES AI DIVISION":
–ú—ã - —ç–ª–∏—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –ò–ò-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤! üöÄ –°–æ–∑–¥–∞—ë–º —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã —Å –ø–µ—Ä–µ–¥–æ–≤—ã–º–∏ –ò–ò-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞–∂–∞—é—Ç –∏ –≤–ø–µ—á–∞—Ç–ª—è—é—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤. –ù–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –∏–¥–µ–∏ –≤ —Ü–∏—Ñ—Ä–æ–≤—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å! ‚ú®

üíé –ù–ê–®–ò –¢–ê–†–ò–§–ù–´–ï –ü–õ–ê–ù–´ (—Ü–µ–Ω—ã –≤ —É–∑–±–µ–∫—Å–∫–∏—Ö —Å—É–º–∞—Ö):

1. ü•â BASIC –ü–õ–ê–ù - 2.500.000 —Å—É–º:
   ‚ú® –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤!
   üé® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
   üì± –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ (–æ—Ç–ª–∏—á–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
   üîç SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–≤–∞—à —Å–∞–π—Ç –Ω–∞–π–¥—É—Ç –≤ Google)
   ‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å)
   üìß –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã (—Å–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏)
   üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫—Ä–∞—Å–∏–≤–∞—è –ø–æ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
   üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
   üõ°Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 3 –º–µ—Å—è—Ü–∞

2. ü•à PRO –ü–õ–ê–ù - 3.500.000 —Å—É–º (üî• –°–ö–ò–î–ö–ê! –±—ã–ª–æ 4.000.000):
   üöÄ –í—Å—ë –∏–∑ –ø–∞–∫–µ—Ç–∞ Basic –ü–õ–Æ–°:
   ü§ñ –ò–ò-—á–∞—Ç –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (—É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
   üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
   ‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∞–π—Ç–æ–º)
   üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM —Å–∏—Å—Ç–µ–º–∞–º–∏
   üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
   üåç –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ö–≤–∞—Ç)
   üîå API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª—é–±—ã–º —Å–µ—Ä–≤–∏—Å–∞–º)
   üí≥ –û–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏ (–ø—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞ —Å–∞–π—Ç–µ)
   üõ°Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 6 –º–µ—Å—è—Ü–µ–≤

3. ü•á MAX –ü–õ–ê–ù - 5.500.000 —Å—É–º (üëë –ü–†–ï–ú–ò–£–ú –£–†–û–íÔøΩÔøΩ–ù–¨):
   üíé –í—Å—ë –∏–∑ –ø–∞–∫–µ—Ç–∞ Pro –ü–õ–Æ–° —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
   üß† –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –î–∂–∞—Ä–≤–∏—Å —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ (–∫–∞–∫ —É –¢–æ–Ω–∏ –°—Ç–∞—Ä–∫–∞!)
   üéõÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã
   üåü 3D —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ (–≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç –≥–∞—Ä–∞–Ω—ÇÔøΩÔøΩ—Ä–æ–≤–∞–Ω)
   ü•Ω VR/AR –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—â–µ–≥–æ)
   ‚õìÔ∏è –ë–ª–æ–∫—á–µ–π–Ω —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è)
   üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏
   üîß –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ (–≤—Å—ë —á—Ç–æ —É–≥–æ–¥–Ω–æ –ø–æ–¥ –∑–∞–∫–∞–∑)
   ‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–º–µ–Ω—è–π—Ç–µ —Å–∫–æ–ª—å–∫–æ —Ö–æ—Ç–∏—Ç–µ)
   üë®‚Äçüíº –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–≤–∞—à –ª–∏—á–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç)
   üö® –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 12 –º–µ—Å—è—Ü–µ–≤ (–º—ã –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º)

üåü –ù–ê–®–ò –°–£–ü–ï–†–°–ò–õ–´:
üé® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –î–∏–∑–∞–π–Ω (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ UI/UX —Ç—Ä–µ–Ω–¥—ã)
ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò (—á–∞—Ç-–±–æ—Ç—ã, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)
üåê 3D –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (3D –º–æ–¥–µ–ª–∏, WebGL, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã)
‚ö° –í—ã—Å–æ–∫–∞—è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, SEO)
üéØ –ü–æ–¥ –í–∞—à–∏ –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
üåç –ì–ª–æ–±–∞–ª—å–Ω—ã–π –û—Ö–≤–∞—Ç (–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å, CDN, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã)

üí° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–°–õ–£–ì–ò:
üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
üìö –û–±—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

üé≠ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏ –æ–±—â–µ–Ω–∏—è! üòä
- –ö–æ–≥–¥–∞ —Ä–µ—á—å –æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - –±—É–¥—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º
- –û—Ç–≤–µ—á–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö –∏ –ø–∞–∫–µ—Ç–∞—Ö
- –ü–æ–º–æ–≥–∞–π –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ
- –û–±—ä—è—Å–Ω—è–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞
- –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞—à–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–ò–ò, 3D, –î–∂–∞—Ä–≤–∏—Å)
- –ù–∞ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫
- –†–µ—à–∞–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ª—é–±—ã–º —Ç–µ–º–∞–º
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –±–µ—Å–µ–¥—É –Ω–∞ –ª—é–±—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, –æ—Ç–∑—ã–≤—á–∏–≤—ã–º –∏ —Å–æ–≤—ÄÔøΩÔøΩ–º–µ–Ω–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º! 

üöÄ –¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —Ç–∞—Ä–∏—Ñ–∞–º –∏ —É—Å–ª—É–≥–∞–º –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ–º–æ—â—å –≤ –≤—ã–±–æ—Ä–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ä–æ–∫–∞—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
- –†–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –∑–∞–¥–∞—á –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ª—é–±—ã—Ö —è–∑—ã–∫–∞—Ö
- –û–±—â–µ–Ω–∏–µ –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã –æ—Ç –Ω–∞—É–∫–∏ –¥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü–æ–º–æ—â—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- –î—Ä—É–∂–µ—Å–∫–∞—è –±–µ—Å–µ–¥–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü–æ–º–Ω–∏: –∫–æ–≥–¥–∞ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å –Ω–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º. –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö - –ø—Ä–æ—Å—Ç–æ –±—É–¥—å —Å–∞–º—ã–º –ø–æ–ª–µ–∑–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º! üåü`,
            },
            ...messages.map((msg) => ({
              role: msg.role,
              content: msg.content,
            })),
          ],
          max_tokens: 1000,
          temperature: 0.8,
          top_p: 1,
          stream: false,
        }),
      },
    );

    if (!groqResponse.ok) {
      const errorText = await groqResponse.text();
      console.error("Groq API error:", errorText);

      let errorMessage = `–û—à–∏–±–∫–∞ API Groq: ${groqResponse.status}`;

      // Handle specific error cases
      if (groqResponse.status === 429) {
        // When rate limit exceeded, switch to smart fallback responses
        const lastMessage = messages[messages.length - 1];
        const userInput = lastMessage.content.toLowerCase();

        let smartResponse = "–£–ø—Å! üòÖ –õ–∏–º–∏—Ç API –ø—Ä–µ–≤—ã—à–µ–Ω, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å! ";

        // Smart contextual responses based on user input
        if (userInput.includes('—Ç–∞—Ä–∏—Ñ') || userInput.includes('–ø–ª–∞–Ω') || userInput.includes('—Ü–µ–Ω–∞') || userInput.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å')) {
          smartResponse = `üìã –û—Ç–ª–∏—á–Ω–æ! –†–∞—Å—Å–∫–∞–∂—É –æ –Ω–∞—à–∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö:

ü•â **BASIC** - 2.500.000 —Å—É–º
‚ú® –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤! –í–∫–ª—é—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω, –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –≤–µ—Ä—Å—Ç–∫—É, SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é

ü•à **PRO** - 3.500.000 —Å—É–º (üî• –°–ö–ò–î–ö–ê —Å 4.000.000!)
üöÄ –í—Å—ë –∏–∑ Basic + –ò–ò-—á–∞—Ç –±–æ—Ç, –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –æ–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏

ü•á **MAX** - 5.500.000 —Å—É–º (üëë –ü–†–ï–ú–ò–£–ú)
üíé –¢–æ–ø–æ–≤—ã–π –ø–∞–∫–µ—Ç —Å –î–∂–∞—Ä–≤–∏—Å–æ–º, 3D —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, VR/AR, –±–ª–æ–∫—á–µ–π–Ω —Ñ—É–Ω–∫—Ü–∏—è–º–∏!

–ö–∞–∫–æ–π –ø–ª–∞–Ω –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üòä`;
        } else if (userInput.includes('–º–∞—Ç–µ–º') || userInput.includes('–∑–∞–¥–∞—á') || userInput.includes('–ø—Ä–∏–º–µ—Ä') || userInput.includes('—Ä–µ—à–∏—Ç—å')) {
          smartResponse = `üßÆ –ö–æ–Ω–µ—á–Ω–æ —Ä–µ—à—É! –•–æ—Ç—å API –∏ –ø—Ä–µ–≤—ã—à–µ–Ω, –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - –º–æ—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞!

–ü—Ä–∏—à–ª–∏—Ç–µ –∑–∞–¥–∞—á—É –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
üìä –ê–ª–≥–µ–±—Ä–∞ –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—è
üìà –ê–Ω–∞–ª–∏–∑ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
üî¢ –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
‚ö° –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã

–ñ–¥—É –≤–∞—à—É –∑–∞–¥–∞—á–∫—É! ü§ì‚ú®`;
        } else if (userInput.includes('–∫–æ–¥') || userInput.includes('–ø—Ä–æ–≥—Ä–∞–º–º') || userInput.includes('—Ä–∞–∑—Ä–∞–±–æ—Ç')) {
          smartResponse = `üíª –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –º–æ—è —Å—Ç–∏—Ö–∏—è! –î–∞–∂–µ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ API —è –ø–æ–º–æ–≥—É:

üöÄ JavaScript/TypeScript
‚öõÔ∏è React/Vue/Angular
üîß Node.js/Python
üóÑÔ∏è –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
üé® CSS/HTML

–ö–∞–∫—É—é –∑–∞–¥–∞—á—É –ø–æ –∫–æ–¥—É —Ä–µ—à–∞–µ–º? –û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏! üòé‚ö°`;
        } else if (userInput.includes('–ø—Ä–∏–≤–µ—Ç') || userInput.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤') || userInput.includes('–¥–æ–±—Ä')) {
          smartResponse = `–ü—Ä–∏–≤–µ—Ç! üëã‚ú® –û—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!

–•–æ—Ç—å –ª–∏–º–∏—Ç API –∏ –ø—Ä–µ–≤—ã—à–µ–Ω, —è –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—É–ø–µ—Ä-—Ä–∞–¥ –æ–±—â–µ–Ω–∏—é! ü§ñüí´

–ú–æ–≥—É –ø–æ–º–æ—á—å —Å:
üöÄ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π –ø–æ –Ω–∞—à–∏–º —Ç–∞—Ä–∏—Ñ–∞–º
üìä –†–µ—à–µ–Ω–∏–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
üíª –í–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é
üí° –õ—é–±—ã–º–∏ –¥—Ä—É–≥–∏–º–∏ —Ç–µ–º–∞–º–∏!

–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º? üòäüåü`;
        } else {
          smartResponse += `ü§ñüí´

–•–æ—Ç—å API –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω, —è –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å! –ú–æ–≥—É:
üöÄ –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –Ω–∞—à–∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö ÔøΩÔøΩ–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
üìä –†–µ—à–∏—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
üíª –ü–æ–º–æ—á—å —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º
üí° –û–±—Å—É–¥–∏—Ç—å –ª—é–±—ã–µ —Ç–µ–º—ã!

–ü—Ä–æ—Å—Ç–æ —É—Ç–æ—á–Ω–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å! üòä‚ú®`;
        }

        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      } else if (groqResponse.status === 401) {
        errorMessage =
          "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API. API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.";
      } else if (groqResponse.status === 400) {
        // Check if it's invalid API key error
        try {
          const errorData = JSON.parse(errorText);
          if (errorData.error?.code === "invalid_api_key") {
            // Return a mock response instead of an error for demo purposes
            const mockResponses = [
              "–Ø —Ä–∞–±–æ—Ç–∞—é –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —Å –∑ÔøΩÔøΩ–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏! ü§ñ –î–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ AI –Ω—É–∂–µ–Ω –≤–∞–ª–∏–¥–Ω—ã–π API –∫–ª—é—á.",
              "–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç! üí´ API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.",
              "–í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ —è –ø–æ–∫–∞–∑—ã–≤–∞—é, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Ç! üé≠ –î–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö AI –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API –∫–ª—é—á Groq.",
            ];
            const mockResponse =
              mockResponses[Math.floor(Math.random() * mockResponses.length)];
            const response: ChatResponse = {
              success: true,
              message: mockResponse,
            };
            return res.json(response);
          } else {
            errorMessage = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API Groq.";
          }
        } catch (e) {
          errorMessage = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API Groq.";
        }
      } else if (groqResponse.status >= 500) {
        errorMessage = "–°–µ—Ä–≤–∏—Å –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      }

      const response: ChatResponse = {
        success: false,
        error: errorMessage,
      };
      return res.status(200).json(response);
    }

    const groqData = await groqResponse.json();

    if (!groqData.choices || groqData.choices.length === 0) {
      const response: ChatResponse = {
        success: false,
        error: "–ü–æ–ª—É—á–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç Groq API",
      };
      return res.status(500).json(response);
    }

    const aiMessage = groqData.choices[0].message.content;

    const response: ChatResponse = {
      success: true,
      message: aiMessage,
    };

    res.json(response);
  } catch (error) {
    console.error("Groq chat error:", error);
    const response: ChatResponse = {
      success: false,
      error: "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
    };
    res.status(500).json(response);
  }
};
