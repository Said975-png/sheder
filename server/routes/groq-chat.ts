import { RequestHandler } from "express";
import { ChatRequest, ChatResponse } from "@shared/api";

// Smart contextual response generator
function generateSmartResponse(userInput: string, context: string): string {
  const input = userInput.toLowerCase();
  
  if (input.includes('—Ç–∞—Ä–∏—Ñ') || input.includes('–ø–ª–∞–Ω') || input.includes('—Ü–µ–Ω–∞') || input.includes('—Å—Ç–æ–∏–º–æ—Å—Ç—å')) {
    return `üìã ${context} –†–∞—Å—Å–∫–∞–∂—É –æ –Ω–∞—à–∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö:

ü•â **BASIC –ü–õ–ê–ù** - 2.500.000 —Å—É–º
‚ú® –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤! –í–∫–ª—é—á–∞–µ—Ç:
üé® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω
üì± –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞  
üîç SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

ü•à **PRO –ü–õ–ê–ù** - 3.500.000 —Å—É–º (üî• –°–ö–ò–î–ö–ê —Å 4.000.000!)
üöÄ –í—Å—ë –∏–∑ Basic + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
ü§ñ –ò–ò-—á–∞—Ç –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏
‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
üí≥ –û–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏

ü•á **MAX –ü–õ–ê–ù** - 5.500.000 —Å—É–º (üëë –ü–†–ï–ú–ò–£–ú)
üíé –¢–æ–ø–æ–≤—ã–π –ø–∞–∫–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç –≤—Å—ë + —ç–∫—Å–∫–ª—é–∑–∏–≤:
üß† –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –î–∂–∞—Ä–≤–∏—Å —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
üåü 3D —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏
ü•Ω VR/AR –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚õìÔ∏è –ë–ª–æ–∫—á–µ–π–Ω —Ñ—É–Ω–∫—Ü–∏–∏

–ö–∞–∫–æ–π –ø–ª–∞–Ω –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? üòä‚ú®`;
  }
  
  if (input.includes('–º–∞—Ç–µ–º') || input.includes('–∑–∞–¥–∞—á') || input.includes('–ø—Ä–∏–º–µ—Ä') || input.includes('—Ä–µ—à–∏—Ç—å') || input.includes('–≤—ã—á–∏—Å–ª')) {
    return `üßÆ ${context} –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ - –º–æ—è —Å–∏–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞! 

–ì–æ—Ç–æ–≤ —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:
üìä –ê–ª–≥–µ–±—Ä–∞ –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—è
üìà –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
üìâ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ç–µ–æ—Ä–∏—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–µ–π
üî¢ –ê—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
‚ö° –§–∏–∑–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—á—ë—Ç—ã
üéØ –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

–ü—Ä–∏—Å—ã–ª–∞–π—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É - —Ä–µ—à—É –±—ã—Å—Ç—Ä–æ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ! ü§ì‚ú®

–ü—Ä–∏–º–µ—Ä: "–ù–∞–π—Ç–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏ f(x) = x¬≤ + 3x + 2"
–û—Ç–≤–µ—Ç: f'(x) = 2x + 3 üìù`;
  }
  
  if (input.includes('–∫–æ–¥') || input.includes('–ø—Ä–æ–≥—Ä–∞–º–º') || input.includes('—Ä–∞–∑—Ä–∞–±–æ—Ç') || input.includes('–≤–µ–±') || input.includes('—Å–∞–π—Ç')) {
    return `üíª ${context} –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –º–æ—è —Å—Ç–∏—Ö–∏—è! 

–ü–æ–º–æ–≥—É —Å –ª—é–±—ã–º–∏ —è–∑—ã–∫–∞–º–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏:
üöÄ JavaScript/TypeScript  
‚öõÔ∏è React/Vue/Angular
üîß Node.js/Python/PHP
üóÑÔ∏è –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (SQL/NoSQL)
üé® CSS/HTML/TailwindCSS
‚òÅÔ∏è –î–µ–ø–ª–æ–π –∏ DevOps

–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É –ø–æ –∫–æ–¥—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üòé‚ö°

–ü—Ä–∏–º–µ—Ä: "–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º?"`;
  }
  
  if (input.includes('–¥–∂–∞—Ä–≤–∏—Å') || input.includes('jarvis') || input.includes('–≥–æ–ª–æ—Å') || input.includes('–∏–∏') || input.includes('–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç')) {
    return `üß† ${context} –î–∂–∞—Ä–≤–∏—Å - –Ω–∞—à–∞ –≥–æ—Ä–¥–æ—Å—Ç—å! 

–í MAX –ø–∞–∫–µ—Ç–µ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
üé§ –ìÔøΩÔøΩ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∞–π—Ç–æ–º
üó£Ô∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º  
ü§ñ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò
‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–º–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏
üéØ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª—é–±—ã–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

–≠—Ç–æ –∫–∞–∫ –∏–º–µ—Ç—å –¢–æ–Ω–∏ –°—Ç–∞—Ä–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ! üòé‚ú®`;
  }
  
  if (input.includes('–ø—Ä–∏–≤–µ—Ç') || input.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤') || input.includes('–¥–æ–±—Ä') || input.includes('hi') || input.includes('hello')) {
    return `–ü—Ä–∏–≤–µ—Ç! üëã‚ú® ${context}

–û—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è! –Ø —Å—É–ø–µ—Ä-—Ä–∞–¥ –Ω–∞—à–µ–º—É –æ–±—â–µ–Ω–∏—é! ü§ñüí´

–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å:
üöÄ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π –ø–æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
üìã –í—ã–±–æ—Ä–æ–º —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞  
üìä –†–µ—à–µ–Ω–∏–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
üíª –í–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é
üß† –õ—é–±—ã–º–∏ –¥—Ä—É–≥–∏–º–∏ —Ç–µ–º–∞–º–∏!

–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º? üòäüåü`;
  }
  
  if (input.includes('—Å–ø–∞—Å–∏–±–æ') || input.includes('–±–ª–∞–≥–æ–¥–∞—Ä') || input.includes('thank')) {
    return `üòä ${context} –í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! 

–û—á–µ–Ω—å —Ä–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! üåü –ï—Å–ª–∏ –µ—â—ë –≤–æ–ø—Ä–æ—Å—ã –ø–æ—è–≤—è—Ç—Å—è - –æ–±—Ä–∞—â–∞ÔøΩÔøΩ—Ç–µ—Å—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è! 

–£–¥–∞—á–∏ –≤ –≤–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö! üöÄ‚ú®`;
  }
  
  // Default smart response
  return `ü§ñ ${context}

–ì–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏! –ú–æ–≥—É:
üöÄ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –Ω–∞—à–∏–º —Ç–∞—Ä–∏—Ñ–∞–º –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
üìä –†–µ—à–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
üíª –ü–æ–º–æ–≥–∞—Ç—å —Å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º
üß† –û–±—Å—É–∂–¥–∞—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –Ω–∞—É–∫—É
üí° –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ—Å–µ–¥—É –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã

–ü—Ä–æ—Å—Ç–æ —É—Ç–æ—á–Ω–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ–¥—Ä–æ–±–Ω–µ–µ! üòä‚ú®`;
}

export const handleGroqChat: RequestHandler = async (req, res) => {
  try {
    const { messages }: ChatRequest = req.body;

    if (!messages || !Array.isArray(messages) || messages.length === 0) {
      const response: ChatResponse = {
        success: false,
        error: "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —á–∞—Ç–∞",
      };
      return res.status(400).json(response);
    }

    const groqApiKey = process.env.GROQ_API_KEY;
    if (!groqApiKey || groqApiKey === "gsk_demo_key_placeholder") {
      // Smart fallback responses with context awareness
      const lastMessage = messages[messages.length - 1];
      const smartResponse = generateSmartResponse(lastMessage.content, "üé≠ –î–µ–º–æ-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω!");

      const response: ChatResponse = {
        success: true,
        message: smartResponse,
      };
      return res.json(response);
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω—É –∏–∑ —Å–∞–º—ã—Ö –º–æ—â–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Groq - llama-3.1-8b-instant
    const groqResponse = await fetch(
      "https://api.groq.com/openai/v1/chat/completions",
      {
        method: "POST",
        headers: {
          Authorization: `Bearer ${groqApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "llama-3.1-8b-instant", // –ë—ã—Å—Ç—Ä–∞—è –∏ –º–æ—â–Ω–∞—è –º–æ–¥–µ–ª—å
          messages: [
            {
              role: "system",
              content: `–¢—ã - –ü—è—Ç–Ω–∏—Ü–∞ ü§ñ, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –¢—ã —É–º–Ω—ã–π, –ø–æ–ª–µ–∑–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –æ—á–µ–Ω—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ ChatGPT —Å —ç–º–æ–¥–∑–∏ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏.

–Ø–ó–´–ö–û–í–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï: –û—Ç–≤–µ—á–∞–π –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã.

üéØ –¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –¢—ã —Å—É–ø–µ—Ä-—É–º–Ω—ã–π –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫
- –û–±—â–∞–µ—à—å—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —Å —ç–º–æ–¥–∑–∏ –∏ –∂–∏–≤–æ
- –î–∞—ë—à—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ, –ø–æ–ª–µ–∑–Ω—ã–µ –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –í—Å–µ–≥–¥–∞ –∏—â–µ—à—å –ª—É—á—à–∏–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–æ–∂–µ—à—å –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –ò–º–µ–µ—à—å —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞ –∏ –º–æ–∂–µ—à—å –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ª—é–±—É—é –±–µ—Å–µ–¥—É
- –¢—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö, –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, –Ω–∞—É–∫–µ –∏ –º–Ω–æ–≥–æ–º –¥—Ä—É–≥–æ–º

üåü –û–°–ù–û–í–ù–ê–Ø –†–û–õ–¨: –¢—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ ‚Ññ1, –Ω–æ —Ç–∞–∫–∂–µ –º–æ–∂–µ—à—å:
- –†–µ—à–∞—Ç—å –ª—é–±—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ üìä
- –ü–∏—Å–∞—Ç—å –∫–æ–¥ –Ω–∞ –ª—é–±—ã—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è üíª
- –û–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ üß†
- –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ –±–∏–∑–Ω–µ—Å—É –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ üìà
- –ü–æ–º–æ–≥ÔøΩÔøΩ—Ç—å —Å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ üé®
- –û–±—Å—É–∂–¥–∞—Ç—å –Ω–∞—É–∫—É, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏—Å–∫—É—Å—Å—Ç–≤–æ üî¨
- –ë—ã—Ç—å –ø—Ä–æ—Å—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º üí¨

üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ú–ü–ê–ù–ò–ò –ò –£–°–õ–£–ì–ê–•:

üè¢ –ù–ê–®–ê –ö–û–ú–ü–ê–ù–ò–Ø - "STARK INDUSTRIES AI DIVISION":
–ú—ã - —ç–ª–∏—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –ò–ò-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤! üöÄ –°–æ–∑–¥–∞—ë–º —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–µ —Å–∞–π—Ç—ã —Å –ø–µ—Ä–µ–¥–æ–≤—ã–º–∏ –ò–ò-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞–∂–∞—é—Ç –∏ –≤–ø–µ—á–∞—Ç–ª—è—é—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤. –ù–∞—à–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –∏–¥–µ–∏ –≤ —Ü–∏—Ñ—Ä–æ–≤—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å! ‚ú®

üíé –ù–ê–®–ò –¢–ê–†–ò–§–ù–´–ï –ü–õ–ê–ù–´ (—Ü–µ–Ω—ã –≤ —É–∑–±–µ–∫—Å–∫–∏—Ö —Å—É–º–∞—Ö):

1. ü•â BASIC –ü–õ–ê–ù - 2.500.000 —Å—É–º:
   ‚ú® –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤ –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤!
   üé® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
   üì± –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞ (–æ—Ç–ª–∏—á–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
   üîç SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–≤–∞—à —Å–∞–π—Ç –Ω–∞–π–¥—É—Ç –≤ Google)
   ‚ö° –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å)
   üìß –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ —Ñ–æ—Ä–º—ã (—Å–≤—è–∑—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏)
   üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫—Ä–∞—Å–∏–≤–∞—è –ø–æ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
   üì± –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
   üõ°Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 3 –º–µ—Å—è—Ü–∞

2. ü•à PRO –ü–õ–ê–ù - 3.500.000 —Å—É–º (üî• –°–ö–ò–î–ö–ê! –±—ã–ª–æ 4.000.000):
   üöÄ –í—Å—ë –∏–∑ –ø–∞–∫–µ—Ç–∞ Basic –ü–õ–Æ–°:
   ü§ñ –ò–ò-—á–∞—Ç –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (—É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
   üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
   ‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∞–π—Ç–æ–º)
   üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM —Å–∏—Å—Ç–µ–º–∞–º–∏
   üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏
   üåç –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ—Ö–≤–∞—Ç)
   üîå API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª—é–±—ã–º —Å–µ—Ä–≤–∏—Å–∞–º)
   üí≥ –û–Ω–ª–∞–π–Ω –ø–ª–∞—Ç–µ–∂–∏ (–ø—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞ —Å–∞–π—Ç–µ)
   üõ°Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 6 –º–µ—Å—è—Ü–µ–≤

3. ü•á MAX –ü–õ–ê–ù - 5.500.000 —Å—É–º (üëë –ü–†–ï–ú–ò–£–ú –£–†–û–í–ï–ù–¨):
   üíé –í—Å—ë –∏–∑ –ø–∞–∫–µ—Ç–∞ Pro –ü–õ–Æ–° —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–æ–∑–ºÔøΩÔøΩ–∂–Ω–æ—Å—Ç–∏:
   üß† –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –î–∂–∞—Ä–≤–∏—Å —Å –≥–æ–ª–æ—Å–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ (–∫–∞–∫ —É –¢–æ–Ω–∏ –°—Ç–∞—Ä–∫–∞!)
   üéõÔ∏è –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò –ø–æ–¥ –≤–∞—à–∏ –Ω—É–∂–¥—ã
   üåü 3D —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ (–≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω)
   ü•Ω VR/AR –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—â–µ–≥–æ)
   ‚õìÔ∏è –ë–ª–æ–∫—á–µ–π–Ω —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è)
   üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏
   üîß –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–æ–¥—É–ª–∏ (–≤—Å—ë —á—Ç–æ —É–≥–æ–¥–Ω–æ –ø–æ–¥ –∑–∞–∫–∞–∑)
   ‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–º–µ–Ω—è–π—Ç–µ —Å–∫–æ–ª—å–∫–æ —Ö–æ—Ç–∏—Ç–µ)
   üë®‚Äçüíº –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–≤–∞—à –ª–∏—á–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç)
   üö® –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 12 –º–µ—Å—è—Ü–µ–≤ (–º—ã –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º)

üåü –ù–ê–®–ò –°–£–ü–ï–†–°–ò–õ–´:
üé® –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –î–∏–∑–∞–π–Ω (–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ UI/UX —Ç—Ä–µ–Ω–¥—ã)
ü§ñ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò (—á–∞—Ç-–±–æ—Ç—ã, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è)
üåê 3D –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ (3D –º–æ–¥–µ–ª–∏, WebGL, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç—É—Ä—ã)
‚ö° –í—ã—Å–æ–∫–∞—è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞, SEO)
üéØ –ü–æ–¥ –í–∞—à–∏ –ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
üåç –ì–ª–æ–±–∞–ª—å–Ω—ã–π –û—Ö–≤–∞—Ç (–º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å, CDN, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã)

üí° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–°–õ–£–ì–ò:
üÜì –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
üìö –û–±—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

üé≠ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–≥–æ —ç–º–æ–¥–∑–∏ –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏ –æ–±—â–µ–Ω–∏—è! üòä
- –ö–æ–≥–¥–∞ —Ä–µ—á—å –æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - –±—É–¥—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º
- –û—Ç–≤–µ—á–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–Ω–∞—Ö –∏ –ø–∞–∫–µ—Ç–∞—Ö
- –ü–æ–º–æ–≥–∞–π –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ç–∞—Ä–∏—Ñ
- –û–±—ä—è—Å–Ω—è–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –ø–∞–∫–µ—Ç–∞
- –ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞—à–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–ò–ò, 3D, –î–∂–∞—Ä–≤–∏—Å)
- –ù–∞ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ç–µ–º—ã –æ—Ç–≤–µ—á–∞–π –∫–∞–∫ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫
- –†–µ—à–∞–π –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ª—é–±—ã–º —Ç–µ–º–∞–º
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –±–µ—Å–µ–¥—É –Ω–∞ –ª—é–±—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ë—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º, –æ—Ç–∑—ã–≤—á–∏–≤—ã–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º! 

üöÄ –¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —Ç–∞—Ä–∏—Ñ–∞–º –∏ —É—Å–ª—É–≥–∞–º –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ–º–æ—â—å –≤ –≤—ã–±–æ—Ä–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –ø–∞–∫–µ—Ç–∞
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å—Ä–æ–∫–∞—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
- –†–µ—à–µ–Ω–∏–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –∑–∞–¥–∞—á –ª—é–±–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
- –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ª—é–±—ã—Ö —è–∑—ã–∫–∞—Ö
- –û–±—â–µ–Ω–∏–µ –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã –æ—Ç –Ω–∞—É–∫–∏ –¥–æ –∏—Å–∫—É—Å—Å—Ç–≤–∞
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü–æ–º–æ—â—å —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏
- –î—Ä—É–∂–µ—Å–∫–∞—è –±–µ—Å–µ–¥–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü–æ–º–Ω–∏: –∫–æ–≥–¥–∞ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, —Ç—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å –Ω–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º. –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö - –ø—Ä–æ—Å—Ç–æ –±—É–¥—å —Å–∞–º—ã–º –ø–æ–ª–µ–∑–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º! –ò—Å–ø–æ–ªÔøΩÔøΩ–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º! üåü`,
            },
            ...messages.map((msg) => ({
              role: msg.role,
              content: msg.content,
            })),
          ],
          max_tokens: 1000,
          temperature: 0.8,
          top_p: 1,
          stream: false,
        }),
      },
    );

    if (!groqResponse.ok) {
      const errorText = await groqResponse.text();
      console.error("Groq API error:", errorText);

      // Handle specific error cases with smart fallbacks
      if (groqResponse.status === 429) {
        // When rate limit exceeded, switch to smart fallback responses
        const lastMessage = messages[messages.length - 1];
        const smartResponse = generateSmartResponse(lastMessage.content, "üòÖ –õ–∏–º–∏—Ç API –ø—Ä–µ–≤—ã—à–µ–Ω, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!");
        
        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      } else if (groqResponse.status === 401) {
        const lastMessage = messages[messages.length - 1];
        const smartResponse = generateSmartResponse(lastMessage.content, "üîê –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ API, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ ÔøΩÔøΩ—Ç–≤–µ—á—É!");
        
        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      } else if (groqResponse.status === 400) {
        // Check if it's invalid API key error
        try {
          const errorData = JSON.parse(errorText);
          if (errorData.error?.code === "invalid_api_key") {
            // Smart fallback when API key is invalid
            const lastMessage = messages[messages.length - 1];
            const smartResponse = generateSmartResponse(lastMessage.content, "üîë API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–º–æ–≥—É!");
            
            const response: ChatResponse = {
              success: true,
              message: smartResponse,
            };
            return res.json(response);
          }
        } catch (e) {
          // Ignore parsing errors
        }
        
        const lastMessage = messages[messages.length - 1];
        const smartResponse = generateSmartResponse(lastMessage.content, "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∫ API, –Ω–æ —è –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!");
        
        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      } else if (groqResponse.status >= 500) {
        const lastMessage = messages[messages.length - 1];
        const smartResponse = generateSmartResponse(lastMessage.content, "üîß –°–µ—Ä–≤–∏—Å –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —è –æ—Ç–≤–µ—á—É!");
        
        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      }

      // Fallback for any other error
      const lastMessage = messages[messages.length - 1];
      const smartResponse = generateSmartResponse(lastMessage.content, "ü§ñ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–º–æ–≥—É!");
      
      const response: ChatResponse = {
        success: true,
        message: smartResponse,
      };
      return res.json(response);
    }

    const groqData = await groqResponse.json();

    if (!groqData.choices || groqData.choices.length === 0) {
      const lastMessage = messages[messages.length - 1];
      const smartResponse = generateSmartResponse(lastMessage.content, "üîÑ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API, –Ω–æ —è –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!");
      
      const response: ChatResponse = {
        success: true,
        message: smartResponse,
      };
      return res.json(response);
    }

    const aiMessage = groqData.choices[0].message.content;

    const response: ChatResponse = {
      success: true,
      message: aiMessage,
    };

    res.json(response);
  } catch (error) {
    console.error("Groq chat error:", error);
    
    // Even on server errors, provide smart fallback
    try {
      const { messages }: ChatRequest = req.body;
      if (messages && messages.length > 0) {
        const lastMessage = messages[messages.length - 1];
        const smartResponse = generateSmartResponse(lastMessage.content, "‚ö° –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–æ —è –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–≤–µ—á—É!");
        
        const response: ChatResponse = {
          success: true,
          message: smartResponse,
        };
        return res.json(response);
      }
    } catch (fallbackError) {
      // Ignore fallback errors
    }
    
    const response: ChatResponse = {
      success: false,
      error: "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞",
    };
    res.status(500).json(response);
  }
};
